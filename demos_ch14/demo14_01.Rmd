---
title: "Data science per psicologi - demo 14.01"
author: "Corrado Caudek"
date: "`r format(Sys.Date())`"
output:
  html_document:
    theme: readable
    highlight: pygments
    code_download: true
---

```{r}
suppressPackageStartupMessages({
  library("here")
  library("tidyverse")
  library("scales")
  library("bayesplot")
  library("distrEx")
})

theme_set(bayesplot::theme_default(base_size = 12))
bayesplot::color_scheme_set("gray")
set.seed(84735)

knitr::opts_chunk$set(
  collapse = TRUE,
  tidy = 'styler',
  fig.width = 6,
  fig.asp = 0.618 # 1 / phi
)
```

# Funzione di verosimiglianza

La funzione di verosmiglianza è la funzione di massa o di densità di probabilità dei dati $y$ vista come una funzione del parametro sconosciuto (o dei parametri sconosciuti) $\theta$. Consideriamo qui la funzione gaussiana:

$$
{\displaystyle f(x)={\frac {1}{\sigma {\sqrt {2\pi }}}}e^{-{\frac {1}{2}}\left({\frac {x-\mu }{\sigma }}\right)^{2}}}
$$

Ci poniamo il problema di costruire la funzione di verosimiglianza per questa densità. Consideriamo prima il caso in cui i dati corrispondono ad una singola osservazione $x$.

La formula precedente dipende dai parametri $\mu$ e $\sigma$ e dai dati $x$. Per costruire la funzione di verosimiglianza, dobbiamo dunque inserire nella formula precedente il singolo valore $x$ che abbiamo ed esaminnare il risultato della funzione per tutti i possibili valori di $\mu$ e $\sigma$. Per semplicità, consideriamo $\sigma$ noto e uguale a 15. Poniamo $x = 114$.

```{r}
x <- 114
mu <- seq(70, 160, length.out = 1e3)
fx <- dnorm(x, mu, sd = 15)
```

Otteniamo così una funzione che ha la forma della gaussiana (ma non ha area unitaria), con il massimo in corrispondenza di 114.

```{r}
plot(mu, fx, type = 'l')
abline(v = 114)
```

Consideriamo ora il caso di 30 osservazioni indipendenti iid, ciascuna delle quali può essere considerata come una realizzazione di una variabile casuale gaussiana di media comune sconosciuta e di deviazione standard 15.

```{r}
n <- 30 
true_sigma <- 15 
```

Generiamo i dati

```{r}
set.seed(123)
true_mu <- 100 
x <- rnorm(n, true_mu, true_sigma)
x
```

La media del campione corrispondenrà alla stima di massima verosimiglianza:

```{r}
mean(x)
```

Costruiamo ora la funzione di verosimiglianza. 

Con solo due osservazioni, si può calcolare la distribuzione congiunta $p(X_1, X_2) = p(X_1) p(X_2 \mid X_1)$. Se le due variabili casuali sono indipendenti, abbiamo semplicemente $p(X_1, X_2) = p(X_1) p(X_2)$. 

Nel caso di $n$ v.c. iid, cascuna distribuita come $\mathcal{N}(\mu, \sigma)$, avremo

$$
p(X_1, \dots, X_n ; \mu, \sigma) = \prod p(X_i; \mu, \sigma).
$$

Il logaritmo della funzione di densità congiunta diventa

$$
\log p(X_1, \dots, X_n ; \mu, \sigma) = \sum \log p(X_i; \mu, \sigma).
$$

Facendo variare i parametri e tenendo costanti i dati, otteniamo la funzione di log-verosmiglianza:

```{r}
log_likelihood <- function(x, mu, sigma = true_sigma) {
  sum(dnorm(x, mu, sigma, log = TRUE))
}
```

Per creare un grafico, possiamo utiliazzare

```{r}
# number of points of the plot
nrep <- 1e4
# Values of the parameter mu for which the LL function will be evaluated.
mu <- seq(90, 110, length.out = nrep)
```

Per ciascun possibile valore del parametro $\mu$ calcoliamo il valore della funzione congiunta di verosimiglianza di tutte le 30 osservazioni. Salviamo i risultati nel vettore `ll`.

```{r}
ll <- rep(NA, nrep)
for (i in 1:nrep) {
  ll[i] <- log_likelihood(x, mu[i], true_sigma)
}
```

Creaiamo un grafico della funzione di log-verosimiglianza.

```{r}
ggplot(
  data.frame(mu, ll),
  aes(x = mu, y = ll)
) +
  geom_line() +
  vline_at(mean(x), color = "red", linetype="dashed") +
  labs(
    y = "Log-verosimiglianza",
    x = c("Parametro \u03BC")
  ) 
```

## Stima di massima verosimiglianza

Troviamo ora la stima di massima verosimiglianza. Tale stima deve coincidere con la media del campione.

```{r}
mu[which.max(ll)]
mean(x)
```

L'approssimazione deriva dal fatto che abbiamo utilizzato un numero finito di punti.


## Informazioni sulla sessione di lavoro

```{r}
utils::sessionInfo()
```


